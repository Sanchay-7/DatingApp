generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ADDED THIS ENUM ---
// Defines the possible states for a user account
enum AccountStatus {
  PENDING_APPROVAL
  ACTIVE
  REJECTED
  BANNED
}

// --- ADDED THIS ENUM ---
// Defines the status of a user-submitted report
enum ReportStatus {
  PENDING
  RESOLVED
}

model User {
  id          String   @id @default(uuid())
  firstName   String
  email       String   @unique
  phoneNumber String   @unique
  password    String

  // --- REPLACED 'isVerified' WITH THIS ---
  accountStatus AccountStatus @default(PENDING_APPROVAL)

  // ✅ Profile fields
  name            String?
  birthday        DateTime?
  gender          String?
  work            String?
  height          Int?
  hometown        String?
  currentLocation String?

  // ✅ JSON fields
  photos        Json?
  preferences   Json?
  
  // ✅ Last active timestamp for online status
  lastActive  DateTime? @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  likesSent     Like[]     @relation("likesSent")
  likesReceived Like[]     @relation("likesReceived")
  conversations ConversationParticipant[]
  messages      Message[]  @relation("messageSender")

  // --- ADDED THESE RELATIONS ---
  reportsSent     Report[] @relation("reportsSent")
  reportsReceived Report[] @relation("reportsReceived")
}

model Like {
  id         String   @id @default(uuid())
  fromUser   User     @relation("likesSent", fields: [fromUserId], references: [id], onDelete: Cascade)
  fromUserId String
  toUser     User     @relation("likesReceived", fields: [toUserId], references: [id], onDelete: Cascade)
  toUserId   String
  createdAt  DateTime @default(now())
}

model Conversation {
  id           String                    @id @default(uuid())
  secretKey    String
  createdAt    DateTime                  @default(now())
  participants ConversationParticipant[]
  messages     Message[]
}

model ConversationParticipant {
  id             String       @id @default(uuid())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String
  createdAt      DateTime     @default(now())

  @@unique([conversationId, userId])
}

model Message {
  id             String       @id @default(uuid())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId String
  sender         User         @relation("messageSender", fields: [senderId], references: [id], onDelete: Cascade)
  senderId       String
  ciphertext     String
  iv             String
  authTag        String
  createdAt      DateTime     @default(now())
}

// --- ADDED NEW ADMIN MODEL ---
// This table stores admin accounts, separate from users
model Admin {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      String   @default("admin") // e.g., "admin", "superadmin"
  createdAt DateTime @default(now())
}

// --- ADDED NEW REPORT MODEL ---
// This table stores user reports for moderation
model Report {
  id             String       @id @default(uuid())
  reason         String
  status         ReportStatus @default(PENDING)
  createdAt      DateTime     @default(now())
  
  // Who reported it
  reporter       User         @relation("reportsSent", fields: [reporterId], references: [id], onDelete: Cascade)
  reporterId     String
  
  // Who was reported
  reportedUser   User         @relation("reportsReceived", fields: [reportedUserId], references: [id], onDelete: Cascade)
  reportedUserId String
}